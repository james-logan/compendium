'use strict';

angular.module('compendiumPrime').controller('careerController', function ($location, $rootScope, $http, STORAGE_URL, $scope) {
  var vm = this;

  // $('.chosen-select').chosen()
  // $('.chosen-select-2').chosen({max_selected_options: 2})

  vm.info = {};
  vm.points;
  vm.tagForm = false;
  vm.timeLineHeight;

  //grabs your profile data from firebase
  $http.get(STORAGE_URL + '/profiles/' + $rootScope.auth.uid + '.json').success(function (data) {
    vm.info = data;
    // vm.timeLineHeight = vm.lineHeight(data.finished)
    timeLineBuilder(vm.info.finished);
  });

  //grabs your points from firebase
  $http.get(STORAGE_URL + '/points/' + $rootScope.auth.uid + '.json').success(function (data) {
    vm.points = data;
    ranker();
  });

  var ranker = function ranker() {
    //grabs your points and determines your rank based on them
    vm.rank = vm.points < 10 ? 'Initiate' : vm.points < 50 ? 'Novenciate' : vm.points < 150 ? 'Curator' : vm.points < 500 ? 'Senticar' : vm.points < 1000 ? 'Cryptonomer' : vm.points < 5000 ? 'Hierophantic' : 'Prime';
  };

  vm.edit = function () {
    //takes you to the profile edit form
    $location.path('/profileform');
  };

  vm.finishedBook = function () {

    $http.get('https://www.googleapis.com/books/v1/volumes?q=' + vm.newBook.title + '&langRestrict=english&maxResults=1&orderBy=relevance&printType=books&projection=lite&key= AIzaSyChXEjLh0EhY7pzGcddLTnlcku596jLl0Y').success(function (data) {
      vm.newBook.author = data.items[0].volumeInfo.authors[0];

      vm.newBook.img = data.items[0].volumeInfo.imageLinks.smallThumbnail;

      // vm.newBook.img = data.items[0].volumeInfo.imageLinks.smallThumbnail
      putRequest();
    });

    vm.newBook.title = vm.newBook.title.split(' ').map(function (word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');

    vm.newBook = {
      title: vm.newBook.title,
      date: new Date()
    };

    var putRequest = function putRequest() {
      $http.put(STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/finished/' + vm.newBook.title.toLowerCase() + '.json', vm.newBook).success(function (data) {
        vm.addPoints(5);
      });
    };

    vm.addPoints = function (pts, cb) {
      $http.get(STORAGE_URL + '/points/' + $rootScope.auth.uid + '.json').success(function (data) {
        data += pts;
        $http.put(STORAGE_URL + '/points/' + $rootScope.auth.uid + '.json', data).success(function () {
          if (cb) {
            cb();
          }
        });
      });
    };

    vm.tagShower();
  };

  vm.tags = {
    space: '',
    subgen: '',
    social: '',
    scientific: '',
    other: ''
  };

  vm.tagPoster = function () {
    var tagPts = 0;
    Object.keys(vm.tags).forEach(function (cat) {
      if (vm.tags.cat != '') {
        tagPts += 2;
      }
    });
    $http.put(STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/finished/' + vm.newBook.title.toLowerCase() + '/tags.json', vm.tags).success(function () {
      vm.addPoints(tagPts, vm.closeTagForm);
    });

    $http.put(STORAGE_URL + 'books/' + vm.newBook.title.toLowerCase() + '/' + $rootScope.auth.uid + '.json', vm.tags).success(function () {});
  };

  vm.tagShower = function () {
    vm.tagForm = true;
  };

  vm.closeTagForm = function () {
    vm.tagForm = false;
    location.reload();
  };

  vm.newBook = {
    title: null,
    page: 0,
    total: 0
  };

  vm.newBookInProgress = function () {
    //adds a new book to your currently reading list

    vm.newBook.title = vm.newBook.title.split(' ').map(function (word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');

    $http.get('https://www.googleapis.com/books/v1/volumes?q=' + vm.newBook.title + '&langRestrict=english&maxResults=1&orderBy=relevance&printType=books&projection=lite&key= AIzaSyChXEjLh0EhY7pzGcddLTnlcku596jLl0Y').success(function (data) {
      vm.newBook.author = data.items[0].volumeInfo.authors[0];

      vm.newBook.img = data.items[0].volumeInfo.imageLinks.smallThumbnail;

      // vm.newBook.img = data.items[0].volumeInfo.imageLinks.smallThumbnail

      $http.put(STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/currentlyreading/' + vm.newBook.title.toLowerCase() + '.json', vm.newBook).success(function () {
        location.reload();
      });
    });
  };

  vm.deleteProgressBook = function (title) {
    $http['delete'](STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/currentlyreading/' + title.toLowerCase() + '.json').success(function () {
      location.reload();
    });
  };

  vm.pageUpdate = function (img, page, total, title) {
    var book = {
      img: img,
      title: title,
      page: page,
      total: total
    };
    if (book.page === book.total) {
      $http['delete'](STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/currentlyreading/' + book.title.toLowerCase() + '.json').success(function () {
        vm.newBook = {
          title: book.title,
          date: new Date()
        };
        vm.finishedBook();
      });
    } else {
      $http.put(STORAGE_URL + 'profiles/' + $rootScope.auth.uid + '/currentlyreading/' + book.title.toLowerCase() + '.json', book).success(function () {});
    }
  };

  //THIS IS CODE FOR THE OLD HOME-MADE TIMELINE CREATION, REPLACED BY TIMELINE JS BELOW

  // vm.lineHeight = function (obj) {
  //   var timelineHeight = 0;
  //   var cat = Object.keys(obj).map(function (key) {
  //       return obj[key]
  //     }).sort(function (a, b) {
  //       var dateA = new Date(a.date)
  //       var dateB = new Date(b.date)
  //       return dateB.getTime() - dateA.getTime()
  //     })
  //   var topVal = 0;
  //   cat.forEach(function (book, i, array) {
  //     var recentDate = new Date(array[0].date)
  //     var bookDate = new Date(book.date)
  //     var potential = (20 * (recentDate.getTime() - bookDate.getTime()))/(1000 * 60 * 60 * 24)
  //     if (potential > topVal) {
  //       topVal = potential;
  //     }
  //     timelineHeight += book.topValue + 100;

  //   })
  //   return topVal + 100;
  // }

  //Takes the data and pushes it onto an object (vm.dataObject.timeline.date) which
  //timelineJS will use to build the timeline widget. And then creates the timeline.

  function timeLineBuilder(data) {
    var point;
    Object.keys(data).forEach(function (key) {
      var date = new Date(data[key].date);
      var date = date.toLocaleDateString();
      point = {
        'startDate': date,
        'headline': '<a href=\'#/book/' + data[key].title.replace('\'', '\'') + '\'>' + data[key].title + '</a>',
        'text': '<p>' + data[key].author + '</p>',
        'classname': 'optionaluniqueclassnamecanbeaddedhere',
        'asset': {
          'media': data[key].img + '.jpeg',
          'thumbnail': data[key].img
        }
      };
      vm.dataObject.timeline.date.push(point);
    });
    //TimelineJS function which actually builds the timeline widget:
    createStoryJS({
      type: 'timeline',
      width: '650',
      height: '550',
      source: vm.dataObject,
      embed_id: 'timeline-embed',
      start_at_end: true
    });
  }

  //Object that timelineJS uses to store the data for the timeline
  vm.dataObject = {
    'timeline': {
      'type': 'default',
      'date': []
    }
  };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9jYXJlZXIuY29udHJvbGxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sQ0FDSixNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FDekIsVUFBVSxDQUFDLGtCQUFrQixFQUFFLFVBQVUsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRTtBQUMzRixNQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7Ozs7O0FBS2QsSUFBRSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7QUFDYixJQUFFLENBQUMsTUFBTSxDQUFDO0FBQ1YsSUFBRSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDbkIsSUFBRSxDQUFDLGNBQWMsQ0FBQzs7O0FBR2xCLE9BQUssQ0FDRixHQUFHLENBQUMsV0FBVyxHQUFHLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FDL0QsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQ3ZCLE1BQUUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDOztBQUVmLG1CQUFlLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtHQUNsQyxDQUFDLENBQUE7OztBQUdKLE9BQUssQ0FDRixHQUFHLENBQUMsV0FBVyxHQUFHLFVBQVUsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FDN0QsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQ3ZCLE1BQUUsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFVBQU0sRUFBRSxDQUFDO0dBQ1YsQ0FBQyxDQUFBOztBQUdKLE1BQUksTUFBTSxHQUFHLFNBQVQsTUFBTSxHQUFlOztBQUV2QixNQUFFLENBQUMsSUFBSSxHQUFHLEFBQUMsRUFBRSxDQUFDLE1BQU0sR0FBRyxFQUFFLEdBQUksVUFBVSxHQUNuQyxBQUFDLEVBQUUsQ0FBQyxNQUFNLEdB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Q0FBQyxDQUFDLEdBQUc7U0FDM0I7T0FDSixDQUFBO0FBQ0QsUUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUV4QyxDQUFDLENBQUE7O0FBRUYsaUJBQWEsQ0FBQztBQUNaLFVBQUksRUFBUSxVQUFVO0FBQ3RCLFdBQUssRUFBTyxLQUFLO0FBQ2pCLFlBQU0sRUFBTSxLQUFLO0FBQ2pCLFlBQU0sRUFBTSxFQUFFLENBQUMsVUFBVTtBQUN6QixjQUFRLEVBQUksZ0JBQWdCO0FBQzVCLGtCQUFZLEVBQUUsSUFBSTtLQUNuQixDQUFDLENBQUM7R0FFSjs7O0FBSUQsSUFBRSxDQUFDLFVBQVUsR0FBRztBQUNkLGNBQVUsRUFDVjtBQUNFLFlBQU0sRUFBQyxTQUFTO0FBQ2hCLFlBQU0sRUFBRSxFQUNQO0tBQ0Y7R0FDRixDQUFBO0NBR0YsQ0FBQyxDQUFBIiwiZmlsZSI6InNyYy9qcy9jYXJlZXIuY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImFuZ3VsYXJcbiAgLm1vZHVsZSgnY29tcGVuZGl1bVByaW1lJylcbiAgLmNvbnRyb2xsZXIoJ2NhcmVlckNvbnRyb2xsZXInLCBmdW5jdGlvbiAoJGxvY2F0aW9uLCAkcm9vdFNjb3BlLCAkaHR0cCwgU1RPUkFHRV9VUkwsICRzY29wZSkge1xuICAgIHZhciB2bSA9IHRoaXM7XG5cbiAgICAvLyAkKCcuY2hvc2VuLXNlbGVjdCcpLmNob3NlbigpXG4gICAgLy8gJCgnLmNob3Nlbi1zZWxlY3QtMicpLmNob3Nlbih7bWF4X3NlbGVjdGVkX29wdGlvbnM6IDJ9KVxuXG4gICAgdm0uaW5mbyA9IHt9O1xuICAgIHZtLnBvaW50cztcbiAgICB2bS50YWdGb3JtID0gZmFsc2U7XG4gICAgdm0udGltZUxpbmVIZWlnaHQ7XG5cbiAgICAvL2dyYWJzIHlvdXIgcHJvZmlsZSBkYXRhIGZyb20gZmlyZWJhc2VcbiAgICAkaHR0cFxuICAgICAgLmdldChTVE9SQUdFX1VSTCArICcvcHJvZmlsZXMvJyArICRyb290U2NvcGUuYXV0aC51aWQgKyAnLmpzb24nKVxuICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgdm0uaW5mbyA9IGRhdGE7XG4gICAgICAgIC8vIHZtLnRpbWVMaW5lSGVpZ2h0ID0gdm0ubGluZUhlaWdodChkYXRhLmZpbmlzaGVkKVxuICAgICAgICB0aW1lTGluZUJ1aWxkZXIodm0uaW5mby5maW5pc2hlZClcbiAgICAgIH0pXG5cbiAgICAvL2dyYWJzIHlvdXIgcG9pbnRzIGZyb20gZmlyZWJhc2VcbiAgICAkaHR0cFxuICAgICAgLmdldChTVE9SQUdFX1VSTCArICcvcG9pbnRzLycgKyAkcm9vdFNjb3BlLmF1dGgudWlkICsgJy5qc29uJylcbiAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIHZtLnBvaW50cyA9IGRhdGE7XG4gICAgICAgIHJhbmtlcigpO1xuICAgICAgfSlcblxuXG4gICAgdmFyIHJhbmtlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vZ3JhYnMgeW91ciBwb2ludHMgYW5kIGRldGVybWluZXMgeW91ciByYW5rIGJhc2VkIG9uIHRoZW1cbiAgICAgIHZtLnJhbmsgPSAodm0ucG9pbnRzIDwgMTApID8gXCJJbml0aWF0ZVwiOlxuICAgICAgICAgICh2bS5wb2ludHM8NTApID8gXCJOb3ZlbmNpYXRlXCI6XG4gICAgICAgICAgKHZtLnBvaW50czwxNTApID8gXCJDdXJhdG9yXCI6XG4gICAgICAgICAgKHZtLnBvaW50czw1MDApID8gXCJTZW50aWNhclwiOlxuICAgICAgICAgICh2bS5wb2ludHM8MTAwMCkgPyBcIkNyeXB0b25vbWVyXCI6XG4gICAgICAgICAgKHZtLnBvaW50czw1MDAwKSA/IFwiSGllcm9waGFudGljXCI6IFwiUHJpbWVcIjtcbiAgICB9XG5cbiAgICB2bS5lZGl0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgLy90YWtlcyB5b3UgdG8gdGhlIHByb2ZpbGUgZWRpdCBmb3JtXG4gICAgICAkbG9jYXRpb24ucGF0aCgnL3Byb2ZpbGVmb3JtJylcbiAgICB9XG5cbiAgICB2bS5maW5pc2hlZEJvb2sgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICRodHRwXG4gICAgICAgIC5nZXQoJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2Jvb2tzL3YxL3ZvbHVtZXM/cT0nICsgdm0ubmV3Qm9vay50aXRsZSArICcmbGFuZ1Jlc3RyaWN0PWVuZ2xpc2gmbWF4UmVzdWx0cz0xJm9yZGVyQnk9cmVsZXZhbmNlJnByaW50VHlwZT1ib29rcyZwcm9qZWN0aW9uPWxpdGUma2V5PSBBSXphU3lDaFhFakxoMEVoWTdwekdjZGRMVG5sY2t1NTk2akxsMFknKVxuICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHZtLm5ld0Jvb2suYXV0aG9yID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmF1dGhvcnNbMF1cblxuICAgICAgICAgIHZtLm5ld0Jvb2suaW1nID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmltYWdlTGlua3Muc21hbGxUaHVtYm5haWxcblxuICAgICAgICAgIC8vIHZtLm5ld0Jvb2suaW1nID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmltYWdlTGlua3Muc21hbGxUaHVtYm5haWxcbiAgICAgICAgICBwdXRSZXF1ZXN0KCk7XG4gICAgICAgIH0pXG5cbiAgICAgIHZtLm5ld0Jvb2sudGl0bGUgPSB2bS5uZXdCb29rLnRpdGxlLnNwbGl0KFwiIFwiKS5tYXAoZnVuY3Rpb24gKHdvcmQpIHtcbiAgICAgICAgcmV0dXJuIHdvcmQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB3b3JkLnNsaWNlKDEpXG4gICAgICB9KS5qb2luKFwiIFwiKTtcblxuICAgICAgdm0ubmV3Qm9vayA9IHtcbiAgICAgICAgdGl0bGU6IHZtLm5ld0Jvb2sudGl0bGUsXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKClcbiAgICAgIH1cblxuICAgICAgdmFyIHB1dFJlcXVlc3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICRodHRwXG4gICAgICAgICAgLnB1dChTVE9SQUdFX1VSTCArICdwcm9maWxlcy8nICsgJHJvb3RTY29wZS5hdXRoLnVpZCArICcvZmluaXNoZWQvJyArIHZtLm5ld0Jvb2sudGl0bGUudG9Mb3dlckNhc2UoKSArICcuanNvbicsIHZtLm5ld0Jvb2spXG4gICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHZtLmFkZFBvaW50cyg1KTtcbiAgICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgICB2bS5hZGRQb2ludHMgPSBmdW5jdGlvbiAocHRzLCBjYikge1xuICAgICAgICAkaHR0cFxuICAgICAgICAgIC5nZXQoU1RPUkFHRV9VUkwgKyAnL3BvaW50cy8nICsgJHJvb3RTY29wZS5hdXRoLnVpZCArICcuanNvbicpXG4gICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIGRhdGEgKz0gcHRzO1xuICAgICAgICAgICAgJGh0dHBcbiAgICAgICAgICAgICAgLnB1dChTVE9SQUdFX1VSTCArICcvcG9pbnRzLycgKyAkcm9vdFNjb3BlLmF1dGgudWlkICsgJy5qc29uJywgZGF0YSlcbiAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChjYikge1xuICAgICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgdm0udGFnU2hvd2VyKCk7XG4gICAgfVxuXG4gICAgdm0udGFncyA9IHtcbiAgICAgIHNwYWNlOiBcIlwiLFxuICAgICAgc3ViZ2VuOiBcIlwiLFxuICAgICAgc29jaWFsOiBcIlwiLFxuICAgICAgc2NpZW50aWZpYzogXCJcIixcbiAgICAgIG90aGVyOiBcIlwiXG4gICAgfVxuXG4gICAgdm0udGFnUG9zdGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIHRhZ1B0cyA9IDA7XG4gICAgICBPYmplY3Qua2V5cyh2bS50YWdzKS5mb3JFYWNoKGZ1bmN0aW9uIChjYXQpIHtcbiAgICAgICAgaWYgKHZtLnRhZ3MuY2F0ICE9IFwiXCIpIHtcbiAgICAgICAgICB0YWdQdHMgKz0gMjtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgICRodHRwXG4gICAgICAgIC5wdXQoU1RPUkFHRV9VUkwgKyAncHJvZmlsZXMvJyArICRyb290U2NvcGUuYXV0aC51aWQgKyAnL2ZpbmlzaGVkLycgKyB2bS5uZXdCb29rLnRpdGxlLnRvTG93ZXJDYXNlKCkgKyAnL3RhZ3MuanNvbicsIHZtLnRhZ3MpXG4gICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2bS5hZGRQb2ludHModGFnUHRzLCB2bS5jbG9zZVRhZ0Zvcm0pXG4gICAgICAgIH0pXG5cbiAgICAgICRodHRwXG4gICAgICAgIC5wdXQoU1RPUkFHRV9VUkwgKyAnYm9va3MvJyArIHZtLm5ld0Jvb2sudGl0bGUudG9Mb3dlckNhc2UoKSArICcvJyArICRyb290U2NvcGUuYXV0aC51aWQgKyAnLmpzb24nLCB2bS50YWdzKVxuICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbiAoKSB7fSlcbiAgICB9XG5cbiAgICB2bS50YWdTaG93ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICB2bS50YWdGb3JtID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB2bS5jbG9zZVRhZ0Zvcm0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICB2bS50YWdGb3JtID0gZmFsc2U7XG4gICAgICBsb2NhdGlvbi5yZWxvYWQoKTtcbiAgICB9XG5cbiAgICB2bS5uZXdCb29rID0ge1xuICAgICAgdGl0bGU6IG51bGwsXG4gICAgICBwYWdlOiAwLFxuICAgICAgdG90YWw6IDBcbiAgICB9XG5cbiAgICB2bS5uZXdCb29rSW5Qcm9ncmVzcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vYWRkcyBhIG5ldyBib29rIHRvIHlvdXIgY3VycmVudGx5IHJlYWRpbmcgbGlzdFxuXG4gICAgICB2bS5uZXdCb29rLnRpdGxlID0gdm0ubmV3Qm9vay50aXRsZS5zcGxpdChcIiBcIikubWFwKGZ1bmN0aW9uICh3b3JkKSB7XG4gICAgICAgIHJldHVybiB3b3JkLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgd29yZC5zbGljZSgxKVxuICAgICAgfSkuam9pbihcIiBcIik7XG5cbiAgICAgICRodHRwXG4gICAgICAgIC5nZXQoJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2Jvb2tzL3YxL3ZvbHVtZXM/cT0nICsgdm0ubmV3Qm9vay50aXRsZSArICcmbGFuZ1Jlc3RyaWN0PWVuZ2xpc2gmbWF4UmVzdWx0cz0xJm9yZGVyQnk9cmVsZXZhbmNlJnByaW50VHlwZT1ib29rcyZwcm9qZWN0aW9uPWxpdGUma2V5PSBBSXphU3lDaFhFakxoMEVoWTdwekdjZGRMVG5sY2t1NTk2akxsMFknKVxuICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHZtLm5ld0Jvb2suYXV0aG9yID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmF1dGhvcnNbMF1cblxuICAgICAgICAgIHZtLm5ld0Jvb2suaW1nID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmltYWdlTGlua3Muc21hbGxUaHVtYm5haWxcblxuICAgICAgICAgIC8vIHZtLm5ld0Jvb2suaW1nID0gZGF0YS5pdGVtc1swXS52b2x1bWVJbmZvLmltYWdlTGlua3Muc21hbGxUaHVtYm5haWxcblxuICAgICAgICAgICRodHRwXG4gICAgICAgICAgICAucHV0KFNUT1JBR0VfVVJMICsgJ3Byb2ZpbGVzLycgKyAkcm9vdFNjb3BlLmF1dGgudWlkICsgJy9jdXJyZW50bHlyZWFkaW5nLycgKyB2bS5uZXdCb29rLnRpdGxlLnRvTG93ZXJDYXNlKCkgKyAnLmpzb24nLCB2bS5uZXdCb29rKVxuICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICBsb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cblxuICAgIH1cblxuICAgIHZtLmRlbGV0ZVByb2dyZXNzQm9vayA9IGZ1bmN0aW9uICh0aXRsZSkge1xuICAgICAgJGh0dHBcbiAgICAgICAgLmRlbGV0ZShTVE9SQUdFX1VSTCArICdwcm9maWxlcy8nICsgJHJvb3RTY29wZS5hdXRoLnVpZCArICcvY3VycmVudGx5cmVhZGluZy8nICsgdGl0bGUudG9Mb3dlckNhc2UoKSArICcuanNvbicpXG4gICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2NhdGlvbi5yZWxvYWQoKTtcblxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHZtLnBhZ2VVcGRhdGUgPSBmdW5jdGlvbiAoaW1nLCBwYWdlLCB0b3RhbCwgdGl0bGUpIHtcbiAgICAgIHZhciBib29rID0ge1xuICAgICAgICBpbWc6IGltZyxcbiAgICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgICBwYWdlOiBwYWdlLFxuICAgICAgICB0b3RhbDogdG90YWxcbiAgICAgIH1cbiAgICAgIGlmIChib29rLnBhZ2UgPT09IGJvb2sudG90YWwpIHtcbiAgICAgICAgJGh0dHBcbiAgICAgICAgICAuZGVsZXRlKFNUT1JBR0VfVVJMICsgJ3Byb2ZpbGVzLycgKyAkcm9vdFNjb3BlLmF1dGgudWlkICsgJy9jdXJyZW50bHlyZWFkaW5nLycgKyBib29rLnRpdGxlLnRvTG93ZXJDYXNlKCkgKyAnLmpzb24nKVxuICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZtLm5ld0Jvb2sgPSB7XG4gICAgICAgICAgICAgIHRpdGxlOiBib29rLnRpdGxlLFxuICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2bS5maW5pc2hlZEJvb2soKTtcbiAgICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgJGh0dHBcbiAgICAgICAgICAucHV0KFNUT1JBR0VfVVJMICsgJ3Byb2ZpbGVzLycgKyAkcm9vdFNjb3BlLmF1dGgudWlkICsgJy9jdXJyZW50bHlyZWFkaW5nLycgKyBib29rLnRpdGxlLnRvTG93ZXJDYXNlKCkgKyAnLmpzb24nLCBib29rKVxuICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vVEhJUyBJUyBDT0RFIEZPUiBUSEUgT0xEIEhPTUUtTUFERSBUSU1FTElORSBDUkVBVElPTiwgUkVQTEFDRUQgQlkgVElNRUxJTkUgSlMgQkVMT1dcblxuICAgIC8vIHZtLmxpbmVIZWlnaHQgPSBmdW5jdGlvbiAob2JqKSB7XG4gICAgLy8gICB2YXIgdGltZWxpbmVIZWlnaHQgPSAwO1xuICAgIC8vICAgdmFyIGNhdCA9IE9iamVjdC5rZXlzKG9iaikubWFwKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAvLyAgICAgICByZXR1cm4gb2JqW2tleV1cbiAgICAvLyAgICAgfSkuc29ydChmdW5jdGlvbiAoYSwgYikge1xuICAgIC8vICAgICAgIHZhciBkYXRlQSA9IG5ldyBEYXRlKGEuZGF0ZSlcbiAgICAvLyAgICAgICB2YXIgZGF0ZUIgPSBuZXcgRGF0ZShiLmRhdGUpXG4gICAgLy8gICAgICAgcmV0dXJuIGRhdGVCLmdldFRpbWUoKSAtIGRhdGVBLmdldFRpbWUoKVxuICAgIC8vICAgICB9KVxuICAgIC8vICAgdmFyIHRvcFZhbCA9IDA7XG4gICAgLy8gICBjYXQuZm9yRWFjaChmdW5jdGlvbiAoYm9vaywgaSwgYXJyYXkpIHtcbiAgICAvLyAgICAgdmFyIHJlY2VudERhdGUgPSBuZXcgRGF0ZShhcnJheVswXS5kYXRlKVxuICAgIC8vICAgICB2YXIgYm9va0RhdGUgPSBuZXcgRGF0ZShib29rLmRhdGUpXG4gICAgLy8gICAgIHZhciBwb3RlbnRpYWwgPSAoMjAgKiAocmVjZW50RGF0ZS5nZXRUaW1lKCkgLSBib29rRGF0ZS5nZXRUaW1lKCkpKS8oMTAwMCAqIDYwICogNjAgKiAyNClcbiAgICAvLyAgICAgaWYgKHBvdGVudGlhbCA+IHRvcFZhbCkge1xuICAgIC8vICAgICAgIHRvcFZhbCA9IHBvdGVudGlhbDtcbiAgICAvLyAgICAgfVxuICAgIC8vICAgICB0aW1lbGluZUhlaWdodCArPSBib29rLnRvcFZhbHVlICsgMTAwO1xuXG4gICAgLy8gICB9KVxuICAgIC8vICAgcmV0dXJuIHRvcFZhbCArIDEwMDtcbiAgICAvLyB9XG5cbiAgICAvL1Rha2VzIHRoZSBkYXRhIGFuZCBwdXNoZXMgaXQgb250byBhbiBvYmplY3QgKHZtLmRhdGFPYmplY3QudGltZWxpbmUuZGF0ZSkgd2hpY2hcbiAgICAvL3RpbWVsaW5lSlMgd2lsbCB1c2UgdG8gYnVpbGQgdGhlIHRpbWVsaW5lIHdpZGdldC4gQW5kIHRoZW4gY3JlYXRlcyB0aGUgdGltZWxpbmUuXG5cbiAgICBmdW5jdGlvbiB0aW1lTGluZUJ1aWxkZXIgKGRhdGEpIHtcbiAgICAgIHZhciBwb2ludDtcbiAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKGRhdGFba2V5XS5kYXRlKVxuICAgICAgICB2YXIgZGF0ZSA9IGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKClcbiAgICAgICAgcG9pbnQgPSB7XG4gICAgICAgICAgICBcInN0YXJ0RGF0ZVwiOiBkYXRlLFxuICAgICAgICAgICAgXCJoZWFkbGluZVwiOiBcIjxhIGhyZWY9JyMvYm9vay9cIiArIGRhdGFba2V5XS50aXRsZS5yZXBsYWNlKFwiJ1wiLCBcIlxcJ1wiKSArIFwiJz5cIiArIGRhdGFba2V5XS50aXRsZSArIFwiPC9hPlwiLFxuICAgICAgICAgICAgXCJ0ZXh0XCI6XCI8cD5cIiArIGRhdGFba2V5XS5hdXRob3IgKyBcIjwvcD5cIixcbiAgICAgICAgICAgIFwiY2xhc3NuYW1lXCI6XCJvcHRpb25hbHVuaXF1ZWNsYXNzbmFtZWNhbmJlYWRkZWRoZXJlXCIsXG4gICAgICAgICAgICBcImFzc2V0XCI6IHtcbiAgICAgICAgICAgICAgXCJtZWRpYVwiOiBkYXRhW2tleV0uaW1nICsgXCIuanBlZ1wiLFxuICAgICAgICAgICAgICBcInRodW1ibmFpbFwiOiBkYXRhW2tleV0uaW1nXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdm0uZGF0YU9iamVjdC50aW1lbGluZS5kYXRlLnB1c2gocG9pbnQpXG5cbiAgICAgIH0pXG4gICAgICAvL1RpbWVsaW5lSlMgZnVuY3Rpb24gd2hpY2ggYWN0dWFsbHkgYnVpbGRzIHRoZSB0aW1lbGluZSB3aWRnZXQ6XG4gICAgICBjcmVhdGVTdG9yeUpTKHtcbiAgICAgICAgdHlwZTogICAgICAgJ3RpbWVsaW5lJyxcbiAgICAgICAgd2lkdGg6ICAgICAgJzY1MCcsXG4gICAgICAgIGhlaWdodDogICAgICc1NTAnLFxuICAgICAgICBzb3VyY2U6ICAgICB2bS5kYXRhT2JqZWN0LFxuICAgICAgICBlbWJlZF9pZDogICAndGltZWxpbmUtZW1iZWQnLFxuICAgICAgICBzdGFydF9hdF9lbmQ6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgfVxuXG5cbiAgICAvL09iamVjdCB0aGF0IHRpbWVsaW5lSlMgdXNlcyB0byBzdG9yZSB0aGUgZGF0YSBmb3IgdGhlIHRpbWVsaW5lXG4gICAgdm0uZGF0YU9iamVjdCA9IHtcbiAgICAgIFwidGltZWxpbmVcIjpcbiAgICAgIHtcbiAgICAgICAgXCJ0eXBlXCI6XCJkZWZhdWx0XCIsXG4gICAgICAgIFwiZGF0ZVwiOiBbXG4gICAgICAgIF1cbiAgICAgIH1cbiAgICB9XG5cblxuICB9KVxuIl19
